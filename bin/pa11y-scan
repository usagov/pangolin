#!/usr/bin/env bash
#
# Run a pa11y scan locally in a near-production configuration
#
# prerequisits:
#  * postgresql running
#  * no other server is listening on port 3000

export RAILS_ENV=ci

# ensure assets are properly compiled for CI environment
bundle exec rake assets:clobber
bundle exec rake assets:precompile

# run the server
bundle exec rails server &
server_pid=$!
# pause to ensure the server has started
sleep 5

# ensure pa11y-ci is installed
yarn install --frozen-lockfile

yarn run pa11y-ci
exit_status=$?

# shut down the server
kill $server_pid

exit $exit_status
